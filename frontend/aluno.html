<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Treinador Pro - Aluno</title>
    <link rel="stylesheet" href="/css/main.css" />
    <style>
      /* Estilo do modal de adicionar treino */
      #modal-treino {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      #modal-treino .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      #modal-treino input,
      #modal-treino textarea {
        width: 100%;
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }

      #modal-treino button {
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #modal-treino button:first-child {
        background-color: #007bff;
        color: white;
      }

      #modal-treino button:last-child {
        background-color: #ccc;
      }
    </style>
  </head>

  <body>
    <header>
      <h1>Treinador Pro</h1>
      <nav>
        <a href="/">Dashboard</a>
        <a href="/views/cadastro.html">Novo Aluno</a>
      </nav>
    </header>

    <main>
      <div class="card">
        <h2>Ficha do Aluno</h2>

        <div id="dados-aluno">
          <p><strong>Nome:</strong> <span id="aluno-nome"></span></p>
          <p><strong>Email:</strong> <span id="aluno-email"></span></p>
          <p><strong>Altura:</strong> <span id="aluno-altura"></span> cm</p>
          <p><strong>Objetivo:</strong> <span id="aluno-objetivo"></span></p>
        </div>

        <hr />

        <h3>Planilha de Treino</h3>

        <form id="form-edicao">
          <textarea
            id="edit-treinoHtml"
            placeholder="Digite ou adicione blocos de treino..."
            rows="10"
            style="width: 100%; resize: vertical"
          ></textarea>

          <div style="margin-top: 10px">
            <button
              type="button"
              onclick="abrirModalTreino()"
              class="btn-acao"
              style="background-color: #007bff; margin-right: 10px"
            >
              + Adicionar Bloco de Treino
            </button>

            <button
              type="submit"
              class="btn-acao"
              style="background-color: #28a745"
            >
              Salvar Alterações
            </button>
          </div>
        </form>

        <p id="msg-edicao" style="margin-top: 15px"></p>
      </div>
    </main>

    <!-- MODAL DE ADICIONAR BLOCO -->
    <div id="modal-treino">
      <div class="modal-content">
        <h3>Novo Bloco de Treino</h3>
        <input
          type="text"
          id="treino-nome"
          placeholder="Nome do Treino (Ex: Treino A)"
        />
        <textarea
          id="treino-exercicios"
          placeholder="Exercícios e observações"
          rows="6"
        ></textarea>
        <div style="margin-top: 10px; text-align: right">
          <button onclick="adicionarBlocoConfirmado()">Adicionar</button>
          <button onclick="fecharModalTreino()">Cancelar</button>
        </div>
      </div>
    </div>

    <script>
      const API_URL = "https://app-jorlan.onrender.com/api/alunos";

      const params = new URLSearchParams(window.location.search);
      const alunoId = params.get("id");

      async function carregarAluno() {
        try {
          const res = await fetch(`${API_URL}/${alunoId}`);
          if (!res.ok) throw new Error("Erro ao carregar aluno");
          const aluno = await res.json();

          document.getElementById("aluno-nome").textContent = aluno.nome;
          document.getElementById("aluno-email").textContent =
            aluno.email || "-";
          document.getElementById("aluno-altura").textContent =
            aluno.alturaCm || "-";
          document.getElementById("aluno-objetivo").textContent =
            aluno.objetivo || "-";
          document.getElementById("edit-treinoHtml").value =
            aluno.treinoHtml || "";
        } catch (error) {
          document.querySelector("main").innerHTML =
            "<p>Erro ao carregar os dados do aluno.</p>";
        }
      }

      document
        .getElementById("form-edicao")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("msg-edicao");
          msg.textContent = "Salvando...";
          msg.style.color = "black";

          const treinoHtml = document.getElementById("edit-treinoHtml").value;

          try {
            const res = await fetch(`${API_URL}/${alunoId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ treinoHtml }),
            });

            if (res.ok) {
              msg.textContent = "Treino atualizado com sucesso!";
              msg.style.color = "green";
            } else {
              msg.textContent = "Erro ao salvar.";
              msg.style.color = "red";
            }
          } catch {
            msg.textContent = "Erro de conexão com o servidor.";
            msg.style.color = "red";
          }
        });

      // ===== MODAL DE ADICIONAR TREINO =====
      function abrirModalTreino() {
        document.getElementById("modal-treino").style.display = "flex";
      }

      function fecharModalTreino() {
        document.getElementById("modal-treino").style.display = "none";
      }

      function adicionarBlocoConfirmado() {
        const nome = document.getElementById("treino-nome").value.trim();
        const conteudo = document
          .getElementById("treino-exercicios")
          .value.trim();
        if (!nome || !conteudo) {
          alert("Preencha o nome do treino e os exercícios.");
          return;
        }

        const textarea = document.getElementById("edit-treinoHtml");
        const novoBloco = `
<div class="bloco-treino">
  <h3>${nome}</h3>
  <p>${conteudo.replace(/\n/g, "<br>")}</p>
</div>
`;

        textarea.value += novoBloco + "\n";
        fecharModalTreino();

        // Limpa inputs do modal
        document.getElementById("treino-nome").value = "";
        document.getElementById("treino-exercicios").value = "";

        textarea.scrollTop = textarea.scrollHeight; // rola para o final
      }

      carregarAluno();
    </script>
  </body>
</html>
