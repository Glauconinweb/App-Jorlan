<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="aluno-titulo">Acompanhamento do Aluno</title>
    <link rel="stylesheet" href="./css/main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="icon" type="image/png" href="/imagem/jjj.jpg" />
  </head>
  <body>
    <header>
      <h1>Jorlan de Araujo</h1>
      <nav>
        <a href="index.html">Meus Alunos</a>
        <a href="cadastro.html">Novo Aluno</a>
      </nav>
    </header>

    <main>
      <h2 id="aluno-nome-header">Detalhes do Aluno</h2>

      <div class="card">
        <h3 id="ficha-titulo-principal">Ficha e Treino (Editar)</h3>

        <form id="form-edicao">
          <input
            type="text"
            id="edit-nome"
            placeholder="Nome Completo"
            required
          />
          <input type="email" id="edit-email" placeholder="Email" />
          <input type="number" id="edit-alturaCm" placeholder="Altura (cm)" />
          <input type="text" id="edit-objetivo" placeholder="Objetivo" />
          <h4 style="color: var(--primary-color); margin-top: 20px">
            Detalhes Cadastrais
          </h4>
          <input type="hidden" id="edit-treinoJson" name="treinoJson" />
          <button type="submit">Salvar Dados</button>
          <p id="msg-edicao" style="margin-top: 10px"></p>
        </form>

        <h2>Divisão de Treino (A/B/C)</h2>

        <div class="tabs">
          <button class="tab-button active" data-tab="tab-a">
            Treino A (Superiores - Puxar)
          </button>
          <button class="tab-button" data-tab="tab-b">
            Treino B (Inferiores)
          </button>
          <button class="tab-button" data-tab="tab-c">
            Treino C (Superiores - Empurrar)
          </button>
        </div>

        <div id="tab-a" class="tab-content active">
          <h3>Treino A - Superiores</h3>
          <div class="exercicios-lista"></div>
          <button class="add-exercicio-btn" data-target="tab-a">
            Adicionar Exercício
          </button>
        </div>

        <div id="tab-b" class="tab-content">
          <h3>Treino B - Inferiores</h3>
          <div class="exercicios-lista"></div>
          <button class="add-exercicio-btn" data-target="tab-b">
            Adicionar Exercício
          </button>
        </div>

        <div id="tab-c" class="tab-content">
          <h3>Treino C - Superiores</h3>
          <div class="exercicios-lista"></div>
          <button class="add-exercicio-btn" data-target="tab-c">
            Adicionar Exercício
          </button>
        </div>

        <button id="gerar-planilha-btn">
          Baixar Planilha de Treino em PDF
        </button>
      </div>

      <div class="card">
        <h3>Registrar Nova Evolução (Planilha de Entrada)</h3>
        <form id="form-evolucao">
          <input
            type="number"
            step="0.1"
            id="peso"
            placeholder="Peso (Kg)"
            required
          />
          <input
            type="number"
            step="0.1"
            id="gordura"
            placeholder="% Gordura (Opcional)"
          />
          <textarea id="observacoes" placeholder="Observações"></textarea>
        </form>
        <p id="msg-evolucao"></p>
      </div>
    </main>

    <script>
      let treinoEstruturado = {};
      const API_URL = "https://app-jorlan.onrender.com/api/alunos";
      const alunoId = new URLSearchParams(window.location.search).get("id");
      let alunoData = null;

      const formatarData = (iso) => new Date(iso).toLocaleDateString("pt-BR");

      const createExercicioHTML = (tabId, count, data = {}) => {
        const uid = `${tabId}-ex-${Date.now()}-${count}`;
        return `<div class="exercicio-item" data-unique-id="${uid}">
                  <div class="exercicio-header">
                    <h4>Exercício ${count}: ${data.nome || ""}</h4>
                    <button type="button" class="remover-exercicio-btn" data-id="${uid}" style="float:right;">Remover</button>
                  </div>
                  <label>Nome do Exercício:</label><input type="text" class="input-nome" value="${
                    data.nome || ""
                  }" placeholder="Ex: Supino Reto" data-field="nome">
                  <label>Séries:</label><input type="number" class="input-series" value="${
                    data.series || "3"
                  }" min="1" data-field="series">
                  <label>Repetições:</label><input type="text" class="input-reps" value="${
                    data.repeticoes || "10-12"
                  }" placeholder="Ex: 10-12" data-field="repeticoes">
                  <label>Carga (Opcional):</label><input type="text" class="input-carga" value="${
                    data.carga || ""
                  }" placeholder="Ex: 20kg (cada lado)" data-field="carga">
                  <label>Intervalo (seg):</label><input type="number" class="input-intervalo" value="${
                    data.intervaloSeg || "60"
                  }" min="10" data-field="intervaloSeg">
                  <label>Observação/Técnica:</label><textarea class="input-obs" placeholder="Ex: Cadência 3-1-1; Falha Concêntrica" data-field="observacoes">${
                    data.observacoes || ""
                  }</textarea>
                </div>`;
      };

      function coletarDadosDasTabs() {
        const dadosColetados = {};
        ["tab-a", "tab-b", "tab-c"].forEach((tabId) => {
          const lista = document.querySelector(`#${tabId} .exercicios-lista`);
          dadosColetados[tabId] = Array.from(
            lista.querySelectorAll(".exercicio-item")
          )
            .map((item) => ({
              nome: item.querySelector(".input-nome").value,
              series: parseInt(item.querySelector(".input-series").value) || 0,
              repeticoes: item.querySelector(".input-reps").value,
              carga: item.querySelector(".input-carga").value,
              intervaloSeg:
                parseInt(item.querySelector(".input-intervalo").value) || 0,
              observacoes: item.querySelector("textarea").value,
            }))
            .filter((ex) => ex.nome);
        });
        return dadosColetados;
      }

      function renderizarTreinoEstruturado(treinoJson) {
        try {
          const dadosTreino = JSON.parse(treinoJson);
          treinoEstruturado = dadosTreino;
          ["tab-a", "tab-b", "tab-c"].forEach((tabId) => {
            const lista = document.querySelector(`#${tabId} .exercicios-lista`);
            lista.innerHTML = "";
            if (dadosTreino[tabId] && Array.isArray(dadosTreino[tabId])) {
              dadosTreino[tabId].forEach((exercicio, index) => {
                lista.insertAdjacentHTML(
                  "beforeend",
                  createExercicioHTML(tabId, index + 1, exercicio)
                );
              });
            }
          });
        } catch (e) {
          console.error("Erro ao carregar ou renderizar JSON do treino:", e);
        }
      }

      async function carregarDados() {
        if (!alunoId) return;
        try {
          const response = await fetch(`${API_URL}/${alunoId}`);
          alunoData = await response.json();
          if (alunoData.error) throw new Error(alunoData.error);
          document.getElementById(
            "aluno-titulo"
          ).textContent = `Acompanhamento de ${alunoData.nome}`;
          document.getElementById("aluno-nome-header").textContent =
            alunoData.nome;
          document.getElementById("edit-nome").value = alunoData.nome || "";
          document.getElementById("edit-email").value = alunoData.email || "";
          document.getElementById("edit-alturaCm").value =
            alunoData.alturaCm || "";
          document.getElementById("edit-objetivo").value =
            alunoData.objetivo || "";
          renderizarTreinoEstruturado(alunoData.treinoHtml);
        } catch (error) {
          document.getElementById(
            "aluno-nome-header"
          ).textContent = `Erro ao carregar dados: ${error.message}`;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const exercicioCounts = { "tab-a": 0, "tab-b": 0, "tab-c": 0 };

        tabButtons.forEach((btn) =>
          btn.addEventListener("click", () => {
            const targetId = btn.getAttribute("data-tab");
            tabButtons.forEach((b) => b.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(targetId).classList.add("active");
          })
        );

        document.querySelectorAll(".add-exercicio-btn").forEach((btn) =>
          btn.addEventListener("click", (e) => {
            const tabId = e.target.getAttribute("data-target");
            exercicioCounts[tabId]++;
            const lista = document.querySelector(`#${tabId} .exercicios-lista`);
            lista.insertAdjacentHTML(
              "beforeend",
              createExercicioHTML(tabId, exercicioCounts[tabId])
            );
          })
        );

        document.body.addEventListener("click", (e) => {
          if (e.target.classList.contains("remover-exercicio-btn")) {
            const el = e.target.closest(".exercicio-item");
            if (el) el.remove();
          }
        });

        carregarDados();
      });
    </script>
  </body>
</html>
