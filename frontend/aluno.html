<!DOCTYPE html>
<html lang="pt-BR">
   
  <head>
       
    <meta charset="UTF-8" />
       
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
       
    <title id="aluno-titulo">Acompanhamento do Aluno</title>
       
    <link rel="stylesheet" href="./css/main.css" />
       
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
       
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
       
    <link rel="icon" type="image/png" href="/imagem/jjj.jpg" />
       
    <style>
            /* CSS Mantido para o layout e tabs */
            body { padding: 0 10px; } header h1 { font-size: 1.5em; } nav a { display: inline-block; margin: 5px 10px; font-size: 0.9em; } input, textarea, button { font-size: 1em; width: 100%; margin-bottom: 8px; } button { cursor: pointer; } .tabs { display: flex; flex-wrap: wrap; } .tab-button { flex: 1 1 auto; margin: 5px 2px; } .tab-content { margin-top: 10px; display: none; padding: 15px; border-radius: 0 8px 8px 8px; background-color: var(--background-card); border: 1px solid var(--accent-light); } .tab-content.active { display: block; } .exercicio-item { border: 1px solid var(--separator); padding: 10px; margin-bottom: 10px; border-radius: 6px; border-left: 5px solid var(--primary-color); } .exercicio-item h4 { margin-top: 0; } .exercicio-item input, .exercicio-item textarea { width: 95%; } table { width: 100%; overflow-x: auto; display: block; } table th, table td { white-space: nowrap; } @media (max-width: 600px) { nav a { display: block; margin: 5px 0; text-align: center; } .tab-button { flex: 1 1 100%; } }
         
    </style>
     
  </head>

   
  <body>
       
    <header>
           
      <h1>Jorlan de Araujo</h1>
           
      <nav>
                <a href="index.html">Meus Alunos</a>        
        <a href="cadastro.html">Novo Aluno</a>      
      </nav>
         
    </header>

       
    <main>
           
      <h2 id="aluno-nome-header">Detalhes do Aluno</h2>

           
      <div class="card">
               
        <h3>Ficha e Treino (Editar)</h3>
               
        <form id="form-edicao">
                   
          <input
            type="text"
            id="edit-nome"
            placeholder="Nome Completo"
            required
          />
                    <input type="email" id="edit-email" placeholder="Email" />  
                 
          <input type="number" id="edit-alturaCm" placeholder="Altura (cm)" />  
                 
          <input type="text" id="edit-objetivo" placeholder="Objetivo" />

                   
          <h4 style="color: var(--primary-color); margin-top: 20px">
            Detalhes Cadastrais
          </h4>
                   
          <input type="hidden" id="edit-treinoJson" name="treinoJson" />

                    <button type="submit">Salvar Dados</button>          
          <p id="msg-edicao" style="margin-top: 10px"></p>
                 
        </form>

               
        <h2>Divisão de Treino (A/B/C)</h2>
               
        <div class="tabs">
                   
          <button class="tab-button active" data-tab="tab-a">
            Treino A (Superiores - Puxar)
          </button>
                   
          <button class="tab-button" data-tab="tab-b">
            Treino B (Inferiores)
          </button>
                   
          <button class="tab-button" data-tab="tab-c">
            Treino C (Superiores - Empurrar)
          </button>
                 
        </div>

               
        <div id="tab-a" class="tab-content active">
                   
          <h3>Treino A - Superiores</h3>
                   
          <div class="exercicios-lista"></div>
                   
          <button class="add-exercicio-btn" data-target="tab-a">
            Adicionar Exercício
          </button>
                 
        </div>
               
        <div id="tab-b" class="tab-content">
                   
          <h3>Treino B - Inferiores</h3>
                   
          <div class="exercicios-lista"></div>
                   
          <button class="add-exercicio-btn" data-target="tab-b">
            Adicionar Exercício
          </button>
                 
        </div>
               
        <div id="tab-c" class="tab-content">
                   
          <h3>Treino C - Superiores</h3>
                   
          <div class="exercicios-lista"></div>
                   
          <button class="add-exercicio-btn" data-target="tab-c">
            Adicionar Exercício
          </button>
                 
        </div>

               
        <button id="gerar-planilha-btn">
          Baixar Planilha de Treino em PDF
        </button>
             
      </div>

           
      <div class="card">
               
        <h3>Registrar Nova Evolução (Planilha de Entrada)</h3>
               
        <form id="form-evolucao">
                   
          <input
            type="number"
            step="0.1"
            id="peso"
            placeholder="Peso (Kg)"
            required
          />
                   
          <input
            type="number"
            step="0.1"
            id="gordura"
            placeholder="% Gordura (Opcional)"
          />
                   
          <textarea id="observacoes" placeholder="Observações"></textarea>      
              <button type="submit">Adicionar Registro</button>        
        </form>
               
        <p id="msg-evolucao"></p>
             
      </div>

           
      <div class="card">
               
        <h3>Gráficos e Histórico de Acompanhamento</h3>
               
        <div class="grafico-container">
                   
          <canvas id="grafico-evolucao" style="max-height: 400px"></canvas>    
             
        </div>
               
        <h4 style="margin-top: 20px; color: var(--primary-color)">
          Histórico Detalhado
        </h4>
               
        <table id="tabela-historico">
                   
          <thead>
                       
            <tr>
                           
              <th>Data</th>
                           
              <th>Peso (Kg)</th>
                           
              <th>% Gordura</th>
                           
              <th>Observações</th>
                           
              <th>Ação</th>
                         
            </tr>
                     
          </thead>
                   
          <tbody></tbody>
                 
        </table>
             
      </div>
         
    </main>

       
    <script>
      let treinoEstruturado = {};
      const API_URL = "https://app-jorlan.onrender.com/api/alunos";
      const alunoId = new URLSearchParams(window.location.search).get("id");
      let alunoData = null,
        chartInstance = null;

      const formatarData = (iso) => new Date(iso).toLocaleDateString("pt-BR"); // ---------------------------------------------------- // FUNÇÕES DE TREINO DINÂMICO // ----------------------------------------------------

      // [FUNÇÃO createExercicioHTML - Mantida da resposta anterior]
      const createExercicioHTML = (tabId, count, data = {}) => {
        const uid = `${tabId}-ex-${Date.now()}-${count}`;
        const exName = data.nome || "";
        const exSeries = data.series || "3";
        const exReps = data.repeticoes || "10-12";
        const exCarga = data.carga || "";
        const exIntervalo = data.intervaloSeg || "60";
        const exObs = data.observacoes || "";

        return `<div class="exercicio-item" data-unique-id="${uid}">
                <div class="exercicio-header">
                    <h4>Exercício ${count}: ${exName}</h4>
                    <button type="button" class="remover-exercicio-btn" data-id="${uid}" style="float:right;">Remover</button>
                </div>
                <label>Nome do Exercício:</label><input type="text" class="input-nome" value="${exName}" placeholder="Ex: Supino Reto" data-field="nome">
                <label>Séries:</label><input type="number" class="input-series" value="${exSeries}" min="1" data-field="series">
                <label>Repetições:</label><input type="text" class="input-reps" value="${exReps}" placeholder="Ex: 10-12" data-field="repeticoes">
                <label>Carga (Opcional):</label><input type="text" class="input-carga" value="${exCarga}" placeholder="Ex: 20kg (cada lado)" data-field="carga">
                <label>Intervalo (seg):</label><input type="number" class="input-intervalo" value="${exIntervalo}" min="10" data-field="intervaloSeg">
                <label>Observação/Técnica:</label><textarea class="input-obs" placeholder="Ex: Cadência 3-1-1; Falha Concêntrica" data-field="observacoes">${exObs}</textarea>
            </div>`;
      };

      // [FUNÇÃO coletarDadosDasTabs - Mantida da resposta anterior]
      function coletarDadosDasTabs() {
        const dadosColetados = {};
        const tabs = ["tab-a", "tab-b", "tab-c"];

        tabs.forEach((tabId) => {
          const lista = document.querySelector(`#${tabId} .exercicios-lista`);
          const exerciciosDOM = lista.querySelectorAll(".exercicio-item");

          dadosColetados[tabId] = Array.from(exerciciosDOM)
            .map((item) => {
              return {
                nome: item.querySelector(".input-nome").value,
                series:
                  parseInt(item.querySelector(".input-series").value) || 0,
                repeticoes: item.querySelector(".input-reps").value,
                carga: item.querySelector(".input-carga").value,
                intervaloSeg:
                  parseInt(item.querySelector(".input-intervalo").value) || 0,
                observacoes: item.querySelector("textarea").value,
              };
            })
            .filter((ex) => ex.nome);
        });
        return dadosColetados;
      }

      // [FUNÇÃO renderizarTreinoEstruturado - Mantida da resposta anterior]
      function renderizarTreinoEstruturado(treinoJson) {
        const tabs = ["tab-a", "tab-b", "tab-c"];
        try {
          const dadosTreino = JSON.parse(treinoJson);
          treinoEstruturado = dadosTreino;

          tabs.forEach((tabId) => {
            const lista = document.querySelector(`#${tabId} .exercicios-lista`);
            lista.innerHTML = "";

            if (dadosTreino[tabId] && Array.isArray(dadosTreino[tabId])) {
              dadosTreino[tabId].forEach((exercicio, index) => {
                lista.insertAdjacentHTML(
                  "beforeend",
                  createExercicioHTML(tabId, index + 1, exercicio)
                );
              });
            }
          });
        } catch (e) {
          console.error("Erro ao carregar ou renderizar JSON do treino:", e);
          // Inicia os campos vazios em caso de erro
        }
      } // ---------------------------------------------------- // FUNÇÕES DE CARREGAMENTO E AJAX // ----------------------------------------------------

      async function deletarRegistro(evolucaoId) {
        if (
          !confirm("Tem certeza que deseja deletar este registro de evolução?")
        )
          return;
        try {
          const response = await fetch(`${API_URL}/evolucao/${evolucaoId}`, {
            method: "DELETE",
          });
          if (response.ok) {
            alert("Registro deletado com sucesso!");
            carregarDados();
          } else {
            const error = await response.json();
            alert(`Falha ao deletar: ${error.error}`);
          }
        } catch {
          alert("Erro de conexão ao deletar registro.");
        }
      }
      window.deletarRegistro = deletarRegistro;

      async function carregarDados() {
        if (!alunoId) return;
        try {
          const response = await fetch(`${API_URL}/${alunoId}`);
          alunoData = await response.json();
          if (alunoData.error) throw new Error(alunoData.error);

          document.getElementById(
            "aluno-titulo"
          ).textContent = `Acompanhamento de ${alunoData.nome}`;
          document.getElementById("aluno-nome-header").textContent =
            alunoData.nome;

          // ✅ PREENCHE FICHA
          document.getElementById("edit-nome").value = alunoData.nome || "";
          document.getElementById("edit-email").value = alunoData.email || "";
          document.getElementById("edit-alturaCm").value =
            alunoData.alturaCm || "";
          document.getElementById("edit-objetivo").value =
            alunoData.objetivo || "";
          // ✅ CARREGA A ESTRUTURA DINÂMICA DO TREINO
          renderizarTreinoEstruturado(alunoData.treinoHtml); // ✅ RENDERIZA OS DADOS

          renderizarTabela(alunoData.evolucao);
          renderizarGrafico(alunoData.evolucao); // Chama o gráfico com dados
        } catch (error) {
          document.getElementById(
            "aluno-nome-header"
          ).textContent = `Erro ao carregar dados: ${error.message}`;
        }
      }

      function renderizarGrafico(evolucao) {
        if (chartInstance) chartInstance.destroy();
        const datas = evolucao.map((e) => formatarData(e.dataRegistro));
        const pesos = evolucao.map((e) => e.pesoKg);
        const gordura = evolucao.map((e) => e.percGordura);
        const ctx = document
          .getElementById("grafico-evolucao")
          .getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: datas,
            datasets: [
              {
                label: "Peso (Kg)",
                data: pesos,
                borderColor: "rgb(75,192,192)",
                tension: 0.3,
                fill: false,
                pointRadius: 6,
              },
              {
                label: "% Gordura",
                data: gordura,
                borderColor: "rgb(255,99,132)",
                tension: 0.3,
                hidden: true,
                fill: false,
                borderDash: [5, 5],
              },
            ],
          },
          options: { responsive: true },
        });
      }

      function renderizarTabela(evolucao) {
        const tbody = document.querySelector("#tabela-historico tbody");
        tbody.innerHTML = "";
        [...evolucao].reverse().forEach((e) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${formatarData(e.dataRegistro)}</td>
                          <td>${e.pesoKg.toFixed(1)} Kg</td>
                          <td>${
            e.percGordura ? e.percGordura.toFixed(1) + "%" : "-"
          }</td>
                          <td>${e.observacoes || "-"}</td>
                          <td><button onclick="deletarRegistro('${
            e.id
          }')" style="padding:5px 10px; background-color:#ff0000; color:white; border-radius:4px; border:none; cursor:pointer;">X</button></td>`;
          tbody.appendChild(tr);
        });
      } // ATUALIZAÇÃO DO ALUNO (PUT) - Salva JSON Formatado

      document
        .getElementById("form-edicao")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const msg = document.getElementById("msg-edicao");

          // 1. Coleta dados da ficha
          const dadosFicha = {
            nome: document.getElementById("edit-nome").value,
            email: document.getElementById("edit-email").value,
            alturaCm: document.getElementById("edit-alturaCm").value,
            objetivo: document.getElementById("edit-objetivo").value,
          };

          // 2. Coleta dados estruturados das Tabs
          const dadosTreinoEstruturado = coletarDadosDasTabs();

          // 3. Monta payload final (Treino Estruturado é salvo como STRING no treinoHtml)
          const dadosParaEnviar = {
            ...dadosFicha,
            treinoHtml: JSON.stringify(dadosTreinoEstruturado),
          };

          try {
            const response = await fetch(`${API_URL}/${alunoId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(dadosParaEnviar),
            });

            if (response.ok) {
              msg.textContent = "Ficha e Treino salvos com sucesso!";
              msg.style.color = "green";
              carregarDados();
            } else {
              msg.textContent = `Falha ao salvar ficha. Erro: ${response.status}`;
              msg.style.color = "red";
            }
          } catch (error) {
            msg.textContent = "Erro de conexão (PUT).";
            msg.style.color = "red";
          }
        }); // Novo registro de evolução (POST)

      document
        .getElementById("form-evolucao")
        .addEventListener("submit", async (e) => {
          /* ... */
        }); // Lógica de Inicialização (Corrigida)

      document.addEventListener("DOMContentLoaded", () => {
        // Lógica de Tabs e botões (Mantida)
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");
        const exercicioCounts = { "tab-a": 0, "tab-b": 0, "tab-c": 0 };
        tabButtons.forEach((btn) =>
          btn.addEventListener("click", () => {
            const targetId = btn.getAttribute("data-tab");
            tabButtons.forEach((b) => b.classList.remove("active"));
            tabContents.forEach((c) => c.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(targetId).classList.add("active");
          })
        );

        document.querySelectorAll(".add-exercicio-btn").forEach((btn) =>
          btn.addEventListener("click", (e) => {
            const tabId = e.target.getAttribute("data-target");
            exercicioCounts[tabId]++;
            const lista = document.querySelector(`#${tabId} .exercicios-lista`);
            lista.insertAdjacentHTML(
              "beforeend",
              createExercicioHTML(tabId, exercicioCounts[tabId])
            );
          })
        );

        document.body.addEventListener("click", (e) => {
          if (e.target.classList.contains("remover-exercicio-btn")) {
            const el = e.target.closest(".exercicio-item");
            if (el) el.remove();
          }
        });

        // ✅ CHAMADA PRINCIPAL AQUI: Garante que os listeners estejam prontos
        carregarDados();
      });

      // Código de jspdf/html2canvas (Não é mais usado no fluxo principal de PDF)
    </script>
     
  </body>
</html>
